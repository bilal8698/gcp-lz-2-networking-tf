# Copyright 2024 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: 'Reusable TF Plan'

on:
  workflow_call:
    inputs:
      stage:
        required: true
        type: string
        description: 'Stage name (networking, ncc-hub-spoke)'
      environment:
        required: true
        type: string
        description: 'Environment (plan or apply)'
    secrets:
      wif_provider:
        required: true
        description: 'Workload Identity Federation Provider'
      service_account:
        required: true
        description: 'Service Account Email'
      outputs_bucket:
        required: true
        description: 'Outputs GCS Bucket Name'
      organization_id:
        required: false
        description: 'GCP Organization ID'
      organization_domain:
        required: false
        description: 'Organization Domain'
      customer_id:
        required: false
        description: 'Google Workspace Customer ID'
      billing_account_id:
        required: false
        description: 'GCP Billing Account ID'
      repository_organization:
        required: false
        description: 'GitHub Organization Name'

env:
  TF_IN_AUTOMATION: true
  TF_CLI_ARGS: '-no-color'

permissions:
  contents: read
  id-token: write
  pull-requests: write

jobs:
  plan:
    name: 'plan'
    runs-on: ubuntu-latest

    steps:
    - name: 'Checkout Repository'
      uses: actions/checkout@v4

    - name: 'Authenticate to Google Cloud'
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.wif_provider }}
        service_account: ${{ secrets.service_account }}

    - name: 'Set up Cloud SDK'
      uses: google-github-actions/setup-gcloud@v2

    - name: 'Download Provider Configuration'
      run: |
        gcloud storage cp gs://${{ secrets.outputs_bucket }}/providers/${{ inputs.stage }}-providers.tf ./terraform/providers.tf
      continue-on-error: true

    - name: 'Download Output Dependencies'
      run: |
        mkdir -p terraform/output_files
        gcloud storage cp gs://${{ secrets.outputs_bucket }}/outputs/vpc-foundation-outputs.json ./terraform/output_files/ || echo "No VPC foundation outputs"
        gcloud storage cp gs://${{ secrets.outputs_bucket }}/outputs/palo-alto-outputs.json ./terraform/output_files/ || echo "No Palo Alto outputs"
      continue-on-error: true

    - name: 'Prepare Variables File'
      if: ${{ secrets.organization_id != '' }}
      env:
        ORGANIZATION_ID: ${{ secrets.organization_id }}
        ORGANIZATION_DOMAIN: ${{ secrets.organization_domain }}
        CUSTOMER_ID: ${{ secrets.customer_id }}
        BILLING_ACCOUNT_ID: ${{ secrets.billing_account_id }}
        REPOSITORY_ORGANIZATION: ${{ secrets.repository_organization }}
      run: |
        if [ -f terraform/terraform.tfvars.cicd ]; then
          envsubst < terraform/terraform.tfvars.cicd > terraform/terraform.tfvars
        fi
      continue-on-error: true

    - name: 'Setup Terraform'
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: '>= 1.5'

    - name: 'Terraform Format Check'
      run: terraform fmt -check -recursive
      working-directory: terraform/
      continue-on-error: true
      id: fmt

    - name: 'Terraform Init'
      run: terraform init
      working-directory: terraform/

    - name: 'Terraform Validate'
      run: terraform validate
      working-directory: terraform/

    - name: 'Terraform Plan'
      run: terraform plan -input=false -lock=false -detailed-exitcode
      working-directory: terraform/
      continue-on-error: true
      id: plan

    - name: 'Generate Plan Output'
      if: always()
      run: |
        terraform plan -input=false -lock=false -no-color > plan_output.txt || true
      working-directory: terraform/

    - name: 'Comment PR'
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const planOutput = fs.existsSync('terraform/plan_output.txt') 
            ? fs.readFileSync('terraform/plan_output.txt', 'utf8') 
            : 'Plan output not available';
          
          const truncatedPlan = planOutput.length > 65000 
            ? planOutput.substring(0, 65000) + '\n\n... (truncated)' 
            : planOutput;
          
          const output = `#### Terraform Format ðŸ–Œ \`${{ steps.fmt.outcome }}\`
          #### Terraform Plan ðŸ“– \`${{ steps.plan.outcome }}\`
          
          <details><summary>Show Plan</summary>
          
          \`\`\`terraform
          ${truncatedPlan}
          \`\`\`
          
          </details>
          
          *Stage: \`${{ inputs.stage }}\`, Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          });

    - name: 'Plan Status'
      if: steps.plan.outcome == 'failure'
      run: exit 1
